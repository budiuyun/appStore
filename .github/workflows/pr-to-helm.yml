name: ç›´æ¥ä»PRåˆ›å»ºHelmåˆ†æ”¯

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'charts/stable/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  build-helm-branch:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºPRå†…å®¹
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
          
      - name: è·å–PRä½œè€…
        id: get-author
        run: |
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          echo "PR_AUTHOR=$PR_AUTHOR" >> $GITHUB_ENV
          echo "PRä½œè€…: $PR_AUTHOR"
          
      - name: é…ç½®Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: å®‰è£…Helm
        run: |
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh
          helm version
          
      - name: æ‰“åŒ…Charts
        run: |
          mkdir -p .release
          # ä½¿ç”¨é€’å½’æŸ¥æ‰¾æ‰€æœ‰çš„Chart
          find charts/stable -name Chart.yaml | while read chart_yaml; do
            chart_dir=$(dirname "$chart_yaml")
            echo "æ‰¾åˆ°Chart: $chart_dir"
            helm package "$chart_dir" -d .release || echo "æ‰“åŒ… $chart_dir å¤±è´¥"
          done
          
          # æ˜¾ç¤ºæ‰“åŒ…ç»“æœ
          echo "æ‰“åŒ…å®Œæˆçš„Charts:"
          ls -la .release/

      - name: åˆ›å»ºindex.yaml
        run: |
          cd .release
          helm repo index .
          echo "index.yamlå†…å®¹:"
          cat index.yaml
          cd ..
          
      - name: åˆ›å»ºæˆ–æ›´æ–°Helmåˆ†æ”¯
        run: |
          # è®¾ç½®ç›®æ ‡åˆ†æ”¯å
          TARGET_BRANCH="helm-${{ env.PR_AUTHOR }}"
          echo "ç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
          
          # å°è¯•åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
          git fetch origin $TARGET_BRANCH || true
          if git show-ref --verify --quiet refs/remotes/origin/$TARGET_BRANCH; then
            echo "åˆ†æ”¯ $TARGET_BRANCH å·²å­˜åœ¨ï¼Œæ›´æ–°åˆ†æ”¯"
            git checkout $TARGET_BRANCH
            git pull origin $TARGET_BRANCH
            git rm -rf *.tgz index.yaml || true
          else
            echo "åˆ›å»ºæ–°åˆ†æ”¯ $TARGET_BRANCH"
            git checkout --orphan $TARGET_BRANCH
            git rm -rf .
          fi
          
          # å¤åˆ¶æ‰“åŒ…å¥½çš„æ–‡ä»¶
          cp -r .release/* .
          
          # åˆ›å»ºREADMEæ–‡ä»¶è®°å½•æ‰€æœ‰æƒä¿¡æ¯
          echo "# Helm Repository for ${{ env.PR_AUTHOR }}" > README.md
          echo "Generated from PR: #${{ github.event.pull_request.number }}" >> README.md
          echo "Owner: ${{ env.PR_AUTHOR }}" >> README.md
          echo "Last updated: $(date)" >> README.md
          echo "" >> README.md
          echo "## Usage" >> README.md
          echo '```bash' >> README.md
          echo "# Add this Helm repository" >> README.md
          echo "helm repo add ${{ env.PR_AUTHOR }}-repo https://raw.githubusercontent.com/${{ github.repository }}/$TARGET_BRANCH/" >> README.md
          echo "# Update repositories" >> README.md
          echo "helm repo update" >> README.md
          echo "# List available charts" >> README.md
          echo "helm search repo ${{ env.PR_AUTHOR }}-repo" >> README.md
          echo '```' >> README.md
          
          # æäº¤å¹¶æ¨é€
          git add *.tgz index.yaml README.md
          git commit -m "ä»PR #${{ github.event.pull_request.number }} æ›´æ–° ${{ env.PR_AUTHOR }} çš„Helm charts"
          
          # æ¨é€åˆ°è¿œç¨‹
          git push -f origin $TARGET_BRANCH
          
      - name: åœ¨PRä¸Šæ·»åŠ è¯„è®º
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          TARGET_BRANCH="helm-${{ env.PR_AUTHOR }}"
          REPO_URL="https://raw.githubusercontent.com/${{ github.repository }}/$TARGET_BRANCH/"
          
          curl -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$PR_NUMBER/comments" \
            -d "{
              \"body\": \"ğŸ‰ å·²æˆåŠŸåˆ›å»º/æ›´æ–°æ‚¨çš„Helmä»“åº“åˆ†æ”¯ï¼\\n\\n- åˆ†æ”¯: \`$TARGET_BRANCH\`\\n- Helmä»“åº“URL: \`$REPO_URL\`\\n\\nä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ·»åŠ æ­¤Helmä»“åº“:\\n\`\`\`bash\\nhelm repo add ${{ env.PR_AUTHOR }}-repo $REPO_URL\\nhelm repo update\\nhelm search repo ${{ env.PR_AUTHOR }}-repo\\n\`\`\`\\n\\nâœ… æ‚¨æ— éœ€ç­‰å¾…PRåˆå¹¶ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä¸Šè¿°URLï¼\"
            }"
          
      - name: æ±‡æŠ¥ç»“æœ
        run: |
          echo "âœ… å·²æˆåŠŸä¸ºç”¨æˆ· ${{ env.PR_AUTHOR }} åˆ›å»º/æ›´æ–°Helmåˆ†æ”¯"
          echo "åˆ†æ”¯åç§°: helm-${{ env.PR_AUTHOR }}"
          echo "ä»“åº“URL: https://raw.githubusercontent.com/${{ github.repository }}/helm-${{ env.PR_AUTHOR }}/" 