name: Create Helm Branch After PR

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write

jobs:
  create-helm-branch:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Get PR Author
        id: get-author
        run: |
          echo "PR_AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV
          echo "PRä½œè€…: ${{ github.event.pull_request.user.login }}"
          
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.10.0
          
      - name: Package Charts
        run: |
          mkdir -p .release
          # ä½¿ç”¨é€’å½’æŸ¥æ‰¾æ‰€æœ‰çš„Chart
          find charts/stable -name Chart.yaml | while read chart_yaml; do
            chart_dir=$(dirname "$chart_yaml")
            echo "æ‰¾åˆ°Chart: $chart_dir"
            helm package "$chart_dir" -d .release || echo "æ‰“åŒ… $chart_dir å¤±è´¥"
          done
          
          # æ˜¾ç¤ºæ‰“åŒ…ç»“æœ
          echo "æ‰“åŒ…å®Œæˆçš„Charts:"
          ls -la .release/

      - name: Create index.yaml
        run: |
          cd .release
          helm repo index .
          echo "index.yamlå†…å®¹:"
          cat index.yaml
          cd ..
          
      - name: Create or Update Helm Branch
        run: |
          # è®¾ç½®ç›®æ ‡åˆ†æ”¯å
          TARGET_BRANCH="helm-${{ env.PR_AUTHOR }}"
          echo "ç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
          
          # å°è¯•åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
          git fetch origin $TARGET_BRANCH || true
          if git show-ref --verify --quiet refs/remotes/origin/$TARGET_BRANCH; then
            echo "åˆ†æ”¯ $TARGET_BRANCH å·²å­˜åœ¨ï¼Œæ›´æ–°åˆ†æ”¯"
            git checkout $TARGET_BRANCH
            git pull origin $TARGET_BRANCH
            git rm -rf *.tgz index.yaml || true
          else
            echo "åˆ›å»ºæ–°åˆ†æ”¯ $TARGET_BRANCH"
            git checkout --orphan $TARGET_BRANCH
            git rm -rf .
          fi
          
          # å¤åˆ¶æ‰“åŒ…å¥½çš„æ–‡ä»¶
          cp -r .release/* .
          
          # åˆ›å»ºREADMEæ–‡ä»¶è®°å½•æ‰€æœ‰æƒä¿¡æ¯
          echo "# Helm Repository for ${{ env.PR_AUTHOR }}" > README.md
          echo "Generated from PR: #${{ github.event.pull_request.number }}" >> README.md
          echo "Owner: ${{ env.PR_AUTHOR }}" >> README.md
          echo "Last updated: $(date)" >> README.md
          echo "" >> README.md
          echo "## Usage" >> README.md
          echo '```bash' >> README.md
          echo "# Add this Helm repository" >> README.md
          echo "helm repo add ${{ env.PR_AUTHOR }}-repo https://raw.githubusercontent.com/${{ github.repository }}/$TARGET_BRANCH/" >> README.md
          echo "# Update repositories" >> README.md
          echo "helm repo update" >> README.md
          echo "# List available charts" >> README.md
          echo "helm search repo ${{ env.PR_AUTHOR }}-repo" >> README.md
          echo '```' >> README.md
          
          # æäº¤å¹¶æ¨é€
          git add *.tgz index.yaml README.md
          git commit -m "Update Helm charts for user ${{ env.PR_AUTHOR }} from PR #${{ github.event.pull_request.number }}"
          
          # ä½¿ç”¨PATä»¤ç‰Œè¿›è¡Œæ¨é€
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git push -f origin $TARGET_BRANCH
          
          echo "å·²ä¸ºç”¨æˆ· ${{ env.PR_AUTHOR }} åˆ›å»º/æ›´æ–°Helmåˆ†æ”¯: $TARGET_BRANCH"
          echo "Helmä»“åº“URL: https://raw.githubusercontent.com/${{ github.repository }}/$TARGET_BRANCH/"
          
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            const author = process.env.PR_AUTHOR;
            const targetBranch = `helm-${author}`;
            const repoUrl = `https://raw.githubusercontent.com/${repoOwner}/${repoName}/${targetBranch}/`;
            
            const message = `ğŸ‰ å·²æˆåŠŸåˆ›å»º/æ›´æ–°Helmä»“åº“åˆ†æ”¯ï¼\n\n` +
                           `- åˆ†æ”¯: \`${targetBranch}\`\n` +
                           `- Helmä»“åº“URL: \`${repoUrl}\`\n\n` +
                           `ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ·»åŠ æ­¤Helmä»“åº“:\n` +
                           `\`\`\`bash\n` +
                           `helm repo add ${author}-repo ${repoUrl}\n` +
                           `helm repo update\n` +
                           `helm search repo ${author}-repo\n` +
                           `\`\`\``;
            
            await github.rest.issues.createComment({
              owner: repoOwner,
              repo: repoName,
              issue_number: prNumber,
              body: message
            }); 